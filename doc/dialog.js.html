<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: dialog.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: dialog.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var Emitter = require('events').EventEmitter ;
var util = require('util') ;
var assert = require('assert') ;
var noop = require('node-noop').noop;
var only = require('only') ;
var debug = require('debug')('drachtio-srf') ;

/**
 * Arguments provided to Dialog constructor.
 * @typedef {Object} Dialog~Options
 * @property {Object} req drachtio Request (only provided when creating a 'uas' dialogs)
 * @property {Object} res drachtio Response
 */

/**
 * SIP Dialog
 * @constructor
 * @param {Srf} srf - Srf instance that created this dialog
 * @param {string} type - type of SIP dialog: 'uac', or 'uas'
 * @param {Dialog~Options} opts 
 */
function Dialog( srf, type, opts ) {
  var types = ['uas','uac'] ;
  assert.ok( -1 !== types.indexOf(type), 'argument \'type\' must be one of ' + types.join(',')) ;

  if (!(this instanceof Dialog)) { return new Dialog( srf, type, opts ); }

  Emitter.call(this); 

  this.srf = srf ;
  this.type = type ;
  this.req = opts.req ;
  this.res = opts.res ;
  this.agent = this.res.agent ;
  this.onHold = false ;

  /**
   * sip properties that uniquely identify this Dialog
   * @type {Dialog~SipInfo}
   */
  this.sip = {} ;

  /**
   * local side of the Dialog
   * @type {Dialog~SipEndpointInfo}
   */
  this.local = {} ;

  /**
   * local side of the Dialog
   * @type {Dialog~SipEndpointInfo}
   */
  this.remote = {} ;

  Object.defineProperty(this, 'id',  {
    get: function() {
      return this.res.stackDialogId ;
    }
  }) ;

  this.srf.addDialog(this) ; 
}
util.inherits(Dialog, Emitter) ;

module.exports = exports = Dialog ;

/**
 * destroy the sip dialog by generating a BYE request
 * @param {Dialog~requestCallback=} cb      callback that returns the generated BYE message
 */
Dialog.prototype.destroy = function(cb) {
  cb = cb || noop ;
  var self = this ;
  this.agent.request({
    method: 'BYE',
    stackDialogId: self.id
  }, function(err, bye) {
    self.srf.removeDialog( self ) ;
    cb(err, bye) ;
  }) ;
} ;

/**
 * modify the dialog session by changing attributes of the media connection
 * @param  {string} sdp - 'hold', 'unhold', or a session description protocol
 */
Dialog.prototype.modifySession = function( sdp ) {

  switch(sdp) {
    case 'hold':
      break ;
    case 'unhold':
      break ;
    default:
      break ;
  }
  throw new Error('unimplemented') ;
} ;

/**
 * This callback provides the SIP request that was generated
 * @callback Dialog~requestCallback
 * @param {Error} err   error returned on non-success
 * @param {Request} req Request that was generated
 */


Dialog.prototype.handle = function( req, res ) {
  debug('Dialog handling message: ', req.method) ;
  switch( req.method ) {
    case 'BYE': 
      this.srf.removeDialog( this ) ;
      res.send(200) ;
      this.emit('destroy', {
        msg: req.msg
      }) ;
      break ;

    case 'INFO':
    case 'NOTIFY':
      this.emit('msg', req, res ) ;
      break ;

    default:
      console.error('Dialog#handle unhandled method: %s', req.method) ;
  }
} ;

//representation
Dialog.prototype.toJSON = function() {
  return( only( this, 'id type sip local remote onHold')) ;
} ;
Dialog.prototype.toString = function() {
  return this.toJSON().toString() ;
} ;

/**
 * SIP Dialog identifiers
 * @typedef {Object} Dialog~SipInfo
 * @property {String} callId - SIP Call-ID
 * @property {String} localTag - tag generated by local side of the Dialog
 * @property {String} remoteTag  - tag generated by the remote side of the Dialog
 */
/**
 * SIP Endpoint identifiers
 * @typedef {Object} Dialog~SipEndpointInfo
 * @property {String} signalingAddress - sip address:port 
 * @property {String} sdp - session description protocol
 */
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Dialog.html">Dialog</a></li><li><a href="Srf.html">Srf</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.3</a> on Sat Oct 31 2015 22:34:09 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
